<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mes Disponibilit√©s - Novembre 2025</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; }
    .container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h1 { color: #2c3e50; text-align: center; }
    .save-btn { background-color: #3498db; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
    .save-btn:hover { background-color: #2980b9; }
    .auto-btn { padding: 8px 14px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    .auto-available { background-color: #2ecc71; color: white; }
    .auto-unavailable { background-color: #e74c3c; color: white; }
    .auto-maybe { background-color: #f39c12; color: white; }
    .legend { display: flex; justify-content: center; gap: 20px; margin: 15px 0; flex-wrap: wrap; }
    .legend-item { display: flex; align-items: center; gap: 5px; }
    .availability-option { cursor: pointer; padding: 8px; margin: 2px; border-radius: 5px; display: inline-block; width: 30px; height: 30px; text-align: center; line-height: 30px; transition: all 0.3s; font-weight: bold; }
    .available { background-color: #2ecc71; color: white; }
    .maybe { background-color: #f39c12; color: white; }
    .unavailable { background-color: #e74c3c; color: white; }
    input[type="radio"] { display: none; }
    input[type="radio"]:checked + .availability-option { transform: scale(1.2); box-shadow: 0 0 10px rgba(0,0,0,0.3); }
    table { border-collapse: collapse; width: 100%; min-width: 800px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background-color: #34495e; color: white; }
    .non-voting-day { background-color: #ecf0f1; color: #7f8c8d; }
    .name-input { padding: 10px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; width: 300px; margin: 10px 0; }
  </style>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://igicmnaxgjzyhujyosse.supabase.co";   // ‚Üê remplace
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnaWNtbmF4Z2p6eWh1anlvc3NlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MjU3OTksImV4cCI6MjA3NzAwMTc5OX0.e2bJclwq4Bn7MrPGJRlDU5pmaJWrgFFBfbWLWEccn_Y";                 // ‚Üê remplace
    const SURVEY_SLUG = "nov-2025";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let SURVEY_ID = null;              // sera cr√©√©/trouv√© automatiquement
    let userSelections = {};           // { "YYYY-MM-DD": "available" | "maybe" | "unavailable" }

    // Jours √† griser (d√©j√† pr√©sents dans ton ancien fichier)
    const nonVotingDays = ["2025-11-01","2025-11-02","2025-11-08","2025-11-09","2025-11-11","2025-11-15","2025-11-16"];
  </script>
</head>
<body>
  <div class="container">
    <h1>üìÖ Mes Disponibilit√©s - Novembre 2025</h1>

    <div style="margin:12px 0;">
      <input id="userName" class="name-input" placeholder="Votre nom et pr√©nom">
    </div>

   <div style="margin:12px 0;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
  <div style="display:flex;gap:8px;flex-wrap:wrap;">
    <button onclick="saveToSupabase()" class="save-btn">üíæ Enregistrer</button>
    <button onclick="deleteMySubmission()" class="save-btn" style="background:#e74c3c;">üóëÔ∏è Effacer mes r√©ponses</button>
  </div>
  <a href="recap.html?survey=nov-2025"
     class="save-btn"
     style="background:#16a085;text-decoration:none;font-weight:bold;">
     üìä Voir le r√©cap
  </a>
</div>


    <div class="auto-fill-buttons" style="margin: 12px 0; display:flex; gap:8px; flex-wrap:wrap;">
      <button class="auto-btn auto-available" onclick="fillAll('available')">‚úÖ Tout Disponible</button>
      <button class="auto-btn auto-unavailable" onclick="fillAll('unavailable')">‚ùå Tout Indisponible</button>
      <button class="auto-btn auto-maybe" onclick="fillAll('maybe')">‚ùì Tout Peut-√™tre</button>
    </div>

    <div class="legend">
      <div class="legend-item"><span class="availability-option available">‚úì</span>Disponible</div>
      <div class="legend-item"><span class="availability-option unavailable">‚úó</span>Indisponible</div>
      <div class="legend-item"><span class="availability-option maybe">?</span>Peut-√™tre</div>
    </div>

    <div class="calendar">
      <table id="availabilityTable">
        <thead><tr><th>Date</th><th>Disponibilit√©</th></tr></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    // --------- G√©n√©ration des dates / tableau ---------
    function generateNovemberDates() {
      const dates = [];
      const startDate = new Date('2025-11-01');
      const endDate = new Date('2025-11-21');
      for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate()+1)) dates.push(new Date(d));
      return dates;
    }
    function isNonVotingDay(date){ return nonVotingDays.includes(date.toISOString().split('T')[0]); }

    function createAvailabilityTable(){
      const tbody = document.getElementById('tableBody'); tbody.innerHTML='';
      const dates = generateNovemberDates();
      dates.forEach(date=>{
        const tr=document.createElement('tr');
        const dateString=date.toISOString().split('T')[0];

        const tdDate=document.createElement('td');
        tdDate.textContent=`${date.getDate()}/${date.getMonth()+1}/${date.getFullYear()}`;
        if(isNonVotingDay(date)) tdDate.classList.add('non-voting-day');
        tr.appendChild(tdDate);

        const tdAvail=document.createElement('td');
        if(isNonVotingDay(date)){
          tdAvail.classList.add('non-voting-day');
          tdAvail.innerHTML='<span style="color:#7f8c8d;">Non disponible</span>';
        } else {
          const types=[{v:'available',s:'‚úì',c:'available'},{v:'unavailable',s:'‚úó',c:'unavailable'},{v:'maybe',s:'?',c:'maybe'}];
          types.forEach(t=>{
            const label=document.createElement('label');
            const input=document.createElement('input');
            input.type='radio'; input.name=`availability-${dateString}`; input.value=t.v;
            input.onchange=()=>userSelections[dateString]=t.v;
            if(userSelections[dateString]===t.v) input.checked=true;

            const span=document.createElement('span');
            span.classList.add('availability-option',t.c); span.textContent=t.s;
            label.appendChild(input); label.appendChild(span);
            tdAvail.appendChild(label);
          });
        }
        tr.appendChild(tdAvail); tbody.appendChild(tr);
      });
    }

    function fillAll(status){
      generateNovemberDates().forEach(date=>{
        if(!isNonVotingDay(date)) userSelections[date.toISOString().split('T')[0]]=status;
      });
      createAvailabilityTable();
    }

    // --------- Supabase : cr√©ation auto du sondage + CRUD simple ---------
    async function ensureSurvey() {
      // 1) Cherche le sondage
      let { data, error } = await supabase
        .from('surveys')
        .select('id')
        .eq('slug', SURVEY_SLUG)
        .maybeSingle();

      if (!data) {
        // 2) S'il n'existe pas : le cr√©er √† partir des dates d√©j√† d√©finies dans la page
        const all = generateNovemberDates();
        const start = all.length ? all[0].toISOString().slice(0,10) : '2025-11-01';
        const end   = all.length ? all[all.length-1].toISOString().slice(0,10) : '2025-11-21';
        const nvd   = (Array.isArray(nonVotingDays) ? nonVotingDays : []).map(String);

        const ins = await supabase
          .from('surveys')
          .insert({
            slug: SURVEY_SLUG,
            title: `Disponibilit√©s ‚Äì ${SURVEY_SLUG}`,
            start_date: start,
            end_date: end,
            non_voting_days: nvd
          })
          .select('id')
          .single();
        if (ins.error) { alert(ins.error.message); throw ins.error; }
        data = ins.data;
      }
      SURVEY_ID = data.id;
    }

    function buildResponsesJSON(){
      const out={};
      for(const [d,v] of Object.entries(userSelections||{})){
        if(v && v!=='unavailable') out[d]=v;
      }
      return out;
    }

    async function preloadByName(){
      const name = document.getElementById('userName').value.trim();
      if (!name || !SURVEY_ID) return;
      const { data, error } = await supabase
        .from('submissions_simple')
        .select('responses')
        .eq('survey_id', SURVEY_ID)
        .eq('user_name', name)
        .maybeSingle();
      if (error) return;
      if (data?.responses) { userSelections = data.responses; createAvailabilityTable(); }
    }

    async function saveToSupabase(){
      const name = document.getElementById('userName').value.trim();
      if (!name) return alert("Entrez votre nom.");
      if (!SURVEY_ID) await ensureSurvey();

      const responses = buildResponsesJSON();
      if (!Object.keys(responses).length) return alert("S√©lectionnez au moins une disponibilit√©.");

      const { error } = await supabase
        .from('submissions_simple')
        .upsert({
          survey_id: SURVEY_ID,
          user_name: name,
          responses,
          updated_at: new Date().toISOString()
        }, { onConflict: 'survey_id,user_name' });

      if (error) return alert(error.message);
      alert("‚úÖ R√©ponses enregistr√©es !");
    }

    async function deleteMySubmission(){
      const name = document.getElementById('userName').value.trim();
      if (!name) return alert("Entrez votre nom.");
      if (!SURVEY_ID) await ensureSurvey();
      if (!confirm(`Effacer les r√©ponses de "${name}" ?`)) return;

      const { error } = await supabase
        .from('submissions_simple')
        .delete()
        .eq('survey_id', SURVEY_ID)
        .eq('user_name', name);

      if (error) return alert(error.message);
      userSelections = {};
      createAvailabilityTable();
      alert("üóëÔ∏è R√©ponses effac√©es.");
    }

    // --------- Init ---------
    document.addEventListener('DOMContentLoaded', async ()=>{
      await ensureSurvey();          // cr√©e ou r√©cup√®re le sondage automatiquement
      createAvailabilityTable();     // affiche le tableau
      const i = document.getElementById('userName');
      if (i) i.addEventListener('blur', preloadByName); // recharge si le nom existe d√©j√†
    });
  </script>
</body>
</html>
