<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mes Disponibilit√©s - Novembre 2025</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { color: #2c3e50; text-align: center; }
    table { border-collapse: collapse; width: 100%; min-width: 800px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background-color: #34495e; color: white; }
    .non-voting-day { background-color: #ecf0f1; color: #7f8c8d; }
    .availability-option { cursor: pointer; padding: 8px; margin: 2px; border-radius: 5px; display: inline-block; width: 30px; height: 30px; text-align: center; line-height: 30px; transition: all 0.3s; font-weight: bold; }
    .available { background-color: #2ecc71; color: white; }
    .maybe { background-color: #f39c12; color: white; }
    .unavailable { background-color: #e74c3c; color: white; }
    input[type="radio"] { display: none; }
    input[type="radio"]:checked + .availability-option { transform: scale(1.2); box-shadow: 0 0 10px rgba(0,0,0,0.3); }
    .save-btn { background-color: #3498db; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
    .save-btn:hover { background-color: #2980b9; }
    .auto-btn { padding: 8px 14px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    .auto-available { background-color: #2ecc71; color: white; }
    .auto-unavailable { background-color: #e74c3c; color: white; }
    .auto-maybe { background-color: #f39c12; color: white; }
    .legend { display: flex; justify-content: center; gap: 20px; margin: 15px 0; flex-wrap: wrap; }
    .legend-item { display: flex; align-items: center; gap: 5px; }
  </style>

  <!-- SUPABASE -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://igicmnaxgjzyhujyosse.supabase.co";   // ‚Üê √† remplacer
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnaWNtbmF4Z2p6eWh1anlvc3NlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MjU3OTksImV4cCI6MjA3NzAwMTc5OX0.e2bJclwq4Bn7MrPGJRlDU5pmaJWrgFFBfbWLWEccn_Y";                 // ‚Üê √† remplacer
    const SURVEY_SLUG = "nov-2025";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let SURVEY_ID = null, session = null, user = null;
  </script>
</head>

<body>
  <div class="container">
    <h1>üìÖ Mes Disponibilit√©s - Novembre 2025</h1>

    <div style="margin:12px 0;">
      <input id="loginEmail" placeholder="Email" style="padding:8px;width:260px;">
      <button onclick="sendMagicLink()" style="padding:8px 12px;">üì© Connexion</button>
    </div>

    <div style="margin:12px 0;">
      <input id="userName" class="name-input" placeholder="Votre nom et pr√©nom">
    </div>

    <div style="margin:12px 0;display:flex;gap:8px;">
      <button onclick="saveToSupabase()" class="save-btn">üíæ Enregistrer</button>
      <a href="recap.html?survey=nov-2025" class="save-btn" style="background:#6c757d;text-decoration:none;">üîó Voir le r√©cap</a>
      <button onclick="deleteMySubmission()" class="save-btn" style="background:#e74c3c;">üóëÔ∏è Effacer mes r√©ponses</button>
    </div>

    <div class="auto-fill-buttons">
      <button class="auto-btn auto-available" onclick="fillAll('available')">‚úÖ Tout Disponible</button>
      <button class="auto-btn auto-unavailable" onclick="fillAll('unavailable')">‚ùå Tout Indisponible</button>
      <button class="auto-btn auto-maybe" onclick="fillAll('maybe')">‚ùì Tout Peut-√™tre</button>
    </div>

    <div class="legend">
      <div class="legend-item"><span class="availability-option available">‚úì</span>Disponible</div>
      <div class="legend-item"><span class="availability-option unavailable">‚úó</span>Indisponible</div>
      <div class="legend-item"><span class="availability-option maybe">?</span>Peut-√™tre</div>
    </div>

    <div class="calendar">
      <table id="availabilityTable">
        <thead><tr><th>Date</th><th>Disponibilit√©</th></tr></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    // ----- TABLEAU DISPONIBILIT√âS -----
    const nonVotingDays = ["2025-11-01","2025-11-02","2025-11-08","2025-11-09","2025-11-11","2025-11-15","2025-11-16"];
    let userSelections = {};

    function generateNovemberDates(){
      const d=[];const s=new Date('2025-11-01');const e=new Date('2025-11-21');
      for(let x=new Date(s);x<=e;x.setDate(x.getDate()+1)) d.push(new Date(x)); return d;
    }
    function isNonVotingDay(date){return nonVotingDays.includes(date.toISOString().split('T')[0]);}

    function createAvailabilityTable(){
      const tbody=document.getElementById('tableBody'); tbody.innerHTML='';
      generateNovemberDates().forEach(date=>{
        const tr=document.createElement('tr');
        const dateString=date.toISOString().split('T')[0];
        const tdDate=document.createElement('td');
        tdDate.textContent=`${date.getDate()}/${date.getMonth()+1}/${date.getFullYear()}`;
        if(isNonVotingDay(date)) tdDate.classList.add('non-voting-day');
        tr.appendChild(tdDate);

        const tdAvail=document.createElement('td');
        if(isNonVotingDay(date)){
          tdAvail.classList.add('non-voting-day');
          tdAvail.innerHTML='<span style="color:#7f8c8d;">Non disponible</span>';
        } else {
          const types=[{v:'available',s:'‚úì',c:'available'},{v:'unavailable',s:'‚úó',c:'unavailable'},{v:'maybe',s:'?',c:'maybe'}];
          types.forEach(t=>{
            const label=document.createElement('label');
            const input=document.createElement('input');
            input.type='radio'; input.name=`availability-${dateString}`; input.value=t.v;
            input.onchange=()=>userSelections[dateString]=t.v;
            if(userSelections[dateString]===t.v) input.checked=true;
            const span=document.createElement('span');
            span.classList.add('availability-option',t.c); span.textContent=t.s;
            label.appendChild(input); label.appendChild(span); tdAvail.appendChild(label);
          });
        }
        tr.appendChild(tdAvail); tbody.appendChild(tr);
      });
    }

    function fillAll(status){
      generateNovemberDates().forEach(date=>{
        if(!isNonVotingDay(date)) userSelections[date.toISOString().split('T')[0]]=status;
      });
      createAvailabilityTable();
    }

    // ----- SUPABASE -----
    async function sendMagicLink(){
      const email=document.getElementById('loginEmail').value.trim();
      if(!email) return alert("Entrez un email");
      const {error}=await supabase.auth.signInWithOtp({email,options:{emailRedirectTo:location.href}});
      if(error) return alert(error.message);
      alert("V√©rifie ton email et reviens ici.");
    }

    async function getSurveyId(){
      const {data,error}=await supabase.from('surveys').select('id').eq('slug',SURVEY_SLUG).single();
      if(error) throw error; SURVEY_ID=data.id;
    }

    function buildResponsesJSON(){
      const out={};
      for(const [d,v] of Object.entries(userSelections||{})){ if(v && v!=='unavailable') out[d]=v; }
      return out;
    }

    async function preloadSubmission(){
      if(!user||!SURVEY_ID) return;
      const {data,error}=await supabase.from('submissions').select('user_name,responses')
        .eq('survey_id',SURVEY_ID).eq('user_id',user.id).maybeSingle();
      if(error) return;
      if(data){ document.getElementById('userName').value=data.user_name||''; userSelections=data.responses||{}; createAvailabilityTable(); }
    }

    async function saveToSupabase(){
      const {data:{session:s}}=await supabase.auth.getSession(); user=s?.user||null;
      if(!user) return alert("Connectez-vous d'abord.");
      const name=document.getElementById('userName').value.trim();
      if(!name) return alert("Entrez votre nom.");
      if(!SURVEY_ID) await getSurveyId();
      const responses=buildResponsesJSON();
      if(!Object.keys(responses).length) return alert("S√©lectionnez au moins une disponibilit√©.");
      const {error}=await supabase.from('submissions').upsert({
        survey_id:SURVEY_ID,user_id:user.id,user_name:name,responses,updated_at:new Date().toISOString()
      },{onConflict:'survey_id,user_id'});
      if(error) return alert(error.message);
      alert("‚úÖ R√©ponses enregistr√©es !");
    }

    async function deleteMySubmission(){
      const {data:{session:s}}=await supabase.auth.getSession(); user=s?.user||null;
      if(!user) return alert("Connectez-vous d'abord.");
      if(!SURVEY_ID) await getSurveyId();
      if(!confirm("Effacer toutes vos r√©ponses ?")) return;
      const {error}=await supabase.from('submissions').delete().eq('survey_id',SURVEY_ID).eq('user_id',user.id);
      if(error) return alert(error.message);
      userSelections={}; createAvailabilityTable(); document.getElementById('userName').value='';
      alert("üóëÔ∏è R√©ponses effac√©es.");
    }

    async function initAuth(){
      await getSurveyId();
      const {data:{session:s}}=await supabase.auth.getSession(); session=s; user=s?.user||null;
      if(user) await preloadSubmission(); else createAvailabilityTable();
    }
    document.addEventListener('DOMContentLoaded', initAuth);
    supabase.auth.onAuthStateChange(async (_evt,s)=>{session=s;user=s?.user||null;if(user)await preloadSubmission();});
  </script>
</body>
</html>
