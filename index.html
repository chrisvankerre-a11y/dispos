<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mes Disponibilit√©s ‚Äî S√©lection de session</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background:#f5f5f5; }
    .container { background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,.1); }
    h1 { color:#2c3e50; text-align:center; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .save-btn { background:#3498db; color:#fff; padding:12px 20px; border:none; border-radius:6px; cursor:pointer; font-size:16px; }
    .save-btn:hover { opacity:.9; }
    .auto-btn { padding:8px 14px; border:none; border-radius:5px; cursor:pointer; font-weight:bold; }
    .auto-available { background:#2ecc71; color:#fff; }
    .auto-unavailable { background:#e74c3c; color:#fff; }
    .auto-maybe { background:#f39c12; color:#fff; }
    .legend { display:flex; justify-content:center; gap:20px; margin:15px 0; flex-wrap:wrap; }
    .legend-item { display:flex; align-items:center; gap:5px; }
    .availability-option { cursor:pointer; padding:8px; margin:2px; border-radius:5px; display:inline-block; width:30px; height:30px; text-align:center; line-height:30px; transition:.2s; font-weight:bold; }
    .available { background:#2ecc71; color:#fff; }
    .maybe { background:#f39c12; color:#fff; }
    .unavailable { background:#e74c3c; color:#fff; }
    input[type="radio"] { display:none; }
    input[type="radio"]:checked + .availability-option,
    .availability-option.on { transform:scale(1.2); box-shadow:0 0 10px rgba(0,0,0,.3); }
    table { border-collapse:collapse; width:100%; min-width:800px; }
    th,td { border:1px solid #ddd; padding:10px; text-align:center; }
    th { background:#34495e; color:#fff; }
    .name-input, .text-input { padding:10px; font-size:16px; border:2px solid #ddd; border-radius:6px; }
    .admin-login input { padding:8px; border:1px solid #ccc; border-radius:6px; }
    .admin-login .btn, .btn-secondary { background:#6c757d; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
    .btn-secondary:hover, .admin-login .btn:hover { opacity:.9; }
    details.admin { margin:12px 0 16px; border:1px dashed #95a5a6; border-radius:8px; padding:10px; background:#fafafa; }
    .admin-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:10px; margin-top:10px; }
    .slots { display:flex; flex-direction:column; gap:8px; margin-top:6px; }
    .slot-row { display:grid; grid-template-columns: 1fr auto 1fr 1fr auto; gap:8px; align-items:center; }
    .slot-row input[type="time"]{ padding:6px; }
    .slot-row input[type="text"]{ padding:6px; border:1px solid #ccc; border-radius:6px; }
    .slot-row button { background:#bdc3c7; border:none; border-radius:6px; padding:6px 10px; cursor:pointer; }
    .slot-row button:hover { background:#95a5a6; }
    .session-bar { display:flex; flex-direction:column; gap:10px; padding:14px; border:1px dashed #bbb; border-radius:8px; background:#fff; margin-bottom:12px; }
    .session-list { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:10px; }
    .card { border:1px solid #e3e3e3; border-radius:10px; padding:10px; background:#fff; display:flex; flex-direction:column; gap:6px; }
    .pill { background:#eef; color:#223; padding:4px 8px; border-radius:999px; font-weight:600; display:inline-block; }
    .muted { color:#666; }
    .hidden { display:none; }
    .error { color:#c0392b; font-weight:600; }
    .slot-note { color:#2c3e50; font-style:italic; font-weight:600; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://igicmnaxgjzyhujyosse.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnaWNtbmF4Z2p6eWh1anlvc3NlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MjU3OTksImV4cCI6MjA3NzAwMTc5OX0.e2bJclwq4Bn7MrPGJRlDU5pmaJWrgFFBfbWLWEccn_Y";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession:false, autoRefreshToken:false, detectSessionInUrl:false } });

    const SURVEY_SLUG = new URLSearchParams(location.search).get("survey") || "";
    let SURVEY_ID = null, START_DATE=null, END_DATE=null, TIME_SLOTS=[], ADMIN_HASH=null, isAdmin=false;
    let userSelections = {};

    function ymdLocal(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }
    function parseISO(s){ return new Date(`${s}T00:00:00`); }
    const rangeDates = (startStr, endStr) => { const out=[]; const start=parseISO(startStr), end=parseISO(endStr); for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)) out.push(new Date(d)); return out; };
    async function sha256Hex(str){ const enc=new TextEncoder().encode(str); const buf=await crypto.subtle.digest('SHA-256', enc); return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join(''); }
    function normalizeTime(t){ if(!t) return t; const [h,m]=String(t).split(':'); return `${String(h||'0').padStart(2,'0')}:${String(m||'0').padStart(2,'0')}`; }
    function normalizeSlots(list){
      return (list||[]).map(s=>({start:normalizeTime(s.start), end:normalizeTime(s.end), label:(s.label||"").trim()}));
    }
    function slotKey(dateIso, slot){ return `${dateIso}|${slot.start}-${slot.end}`; }
    function expectedKeySet(){ const set=new Set(); const slots=(TIME_SLOTS?.length?TIME_SLOTS:[{start:'',end:''}]); const start=parseISO(START_DATE), end=parseISO(END_DATE); for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){ const ymd=ymdLocal(d); slots.forEach(s=>set.add(`${ymd}|${s.start}-${s.end}`)); } return set; }

    async function fetchAndRenderSessions(){
      const chooser = document.getElementById('chooserOnly');
      const list = document.getElementById('sessionList');
      const empty = document.getElementById('noSessions');
      const error = document.getElementById('errorBox');

      if (chooser) chooser.classList.remove('hidden');
      if (list) list.innerHTML = "";
      if (empty) empty.classList.add('hidden');
      if (error) error.textContent = "";

      const { data, error:err } = await supabase
        .from("surveys")
        .select("slug, title, start_date, end_date")
        .order("slug", { ascending: true });

      if (err) { if (error) error.textContent = "Erreur de chargement des sessions."; return; }
      if (!data || data.length === 0) { if (empty) empty.classList.remove('hidden'); return; }

      data.forEach(s => {
        const card = document.createElement('div'); card.className = 'card';
        card.innerHTML = `
          <div><span class="pill">${s.slug}</span></div>
          <div class="muted">${(s.title||"").replaceAll("<","&lt;")}</div>
          <div class="muted">${s.start_date||""} ‚Üí ${s.end_date||""}</div>
          <div><a class="btn-secondary" href="${location.pathname}?survey=${encodeURIComponent(s.slug)}">Ouvrir</a>
               <a class="btn-secondary" href="recap.html?survey=${encodeURIComponent(s.slug)}">R√©cap</a></div>
        `;
        if (list) list.appendChild(card);
      });
    }

    function markGroup(key, value){
      const group = document.getElementsByName(`availability-${key}`);
      group.forEach(inp => { const span=inp.nextElementSibling; if(span?.classList.contains('availability-option')) { if(inp.value===value) span.classList.add('on'); else span.classList.remove('on'); } });
    }

    function slotHeaderText(s){
      return (s.start&&s.end)?`${s.start} ‚Äì ${s.end}${s.label? " ‚Äî "+s.label : ""}`:'Journ√©e';
    }

    function renderSlotsEditor(){
      const wrap = document.getElementById('slots'); if(!wrap) return; wrap.innerHTML='';
      const list = (Array.isArray(TIME_SLOTS) && TIME_SLOTS.length) ? TIME_SLOTS : [{start:'09:00', end:'12:00', label:''}];
      TIME_SLOTS = normalizeSlots(JSON.parse(JSON.stringify(list)));
      TIME_SLOTS.forEach((s,idx)=>{
        const row = document.createElement('div'); row.className='slot-row';
        row.innerHTML = `
          <input type="time" value="${s.start}" data-idx="${idx}" data-kind="start">
          <span>‚Üí</span>
          <input type="time" value="${s.end}" data-idx="${idx}" data-kind="end">
          <input type="text" placeholder="Description (optionnel)" value="${s.label||""}" data-idx="${idx}" data-kind="label">
          <button type="button" data-idx="${idx}" class="rm">Supprimer</button>
        `;
        wrap.appendChild(row);
      });
      wrap.querySelectorAll('input[type="time"], input[type="text"]').forEach(inp=>{
        inp.onchange = (e)=>{
          const i = +e.target.dataset.idx, k=e.target.dataset.kind, v=(k==="label"? e.target.value : normalizeTime(e.target.value));
          TIME_SLOTS[i][k]= (k==="label") ? String(v||"").trim() : v;
          createAvailabilityTable();
        };
      });
      wrap.querySelectorAll('button.rm').forEach(btn=>{
        btn.onclick = ()=>{
          const i = +btn.dataset.idx;
          TIME_SLOTS.splice(i,1);
          if(TIME_SLOTS.length===0) TIME_SLOTS.push({start:'09:00', end:'12:00', label:''});
          renderSlotsEditor();
          createAvailabilityTable();
        };
      });
    }
    function addSlot(){ if(!Array.isArray(TIME_SLOTS)) TIME_SLOTS=[]; TIME_SLOTS.push({start:'14:00', end:'17:00', label:''}); TIME_SLOTS=normalizeSlots(TIME_SLOTS); renderSlotsEditor(); createAvailabilityTable(); }

    function createAvailabilityTable(){
      const theadRow = document.getElementById('theadRow');
      const tbody = document.getElementById('tableBody');
      if(!theadRow || !tbody) return;
      theadRow.innerHTML = ''; tbody.innerHTML = '';
      if (!START_DATE || !END_DATE) return;

      const headDate = document.createElement('th'); headDate.textContent='Date'; theadRow.appendChild(headDate);
      const slots = (Array.isArray(TIME_SLOTS) && TIME_SLOTS.length) ? TIME_SLOTS : [{start:'',end:'',label:''}];
      slots.forEach(s=>{ const th=document.createElement('th'); th.innerHTML = slotHeaderText(s); theadRow.appendChild(th); });

      rangeDates(START_DATE, END_DATE).forEach(date=>{
        const dateIso = ymdLocal(date);
        const tr = document.createElement('tr');
        const tdDate = document.createElement('td');
        tdDate.textContent = `${date.getDate()}/${date.getMonth()+1}/${date.getFullYear()}`;
        tr.appendChild(tdDate);

        const slots2 = (Array.isArray(TIME_SLOTS) && TIME_SLOTS.length) ? TIME_SLOTS : [{start:'',end:'',label:''}];
        slots2.forEach(slot=>{
          const td = document.createElement('td');
          const key = slotKey(dateIso, slot);
          const types = [
            { v:'available', s:'‚úì', c:'available' },
            { v:'unavailable', s:'‚úó', c:'unavailable' },
            { v:'maybe', s:'?', c:'maybe' }
          ];
          types.forEach(t=>{
            const label=document.createElement('label');
            const input=document.createElement('input');
            input.type='radio'; input.name=`availability-${key}`; input.value=t.v; input.dataset.key=key;
            input.onchange=()=>{ userSelections[key]=t.v; markGroup(key, t.v); };
            const initVal=userSelections[key]||'unavailable';
            if (initVal===t.v) input.checked=true;
            const span=document.createElement('span'); span.classList.add('availability-option',t.c); span.textContent=t.s;
            if (initVal===t.v) span.classList.add('on');
            label.appendChild(input); label.appendChild(span); td.appendChild(label);
          });
          if (!userSelections[key]) markGroup(key, 'unavailable');
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      const aS=document.getElementById('admStart'); if(aS&&START_DATE) aS.value=START_DATE;
      const aE=document.getElementById('admEnd'); if(aE&&END_DATE) aE.value=END_DATE;
    }

    function applySurveyState(s){ SURVEY_ID=s.id; START_DATE=s.start_date; END_DATE=s.end_date; TIME_SLOTS=normalizeSlots(Array.isArray(s.time_slots)?s.time_slots:[]); ADMIN_HASH=s.admin_password_hash||null; renderSlotsEditor(); }

    async function ensureSurveyExistsOrFail(){
      const got = await supabase.from('surveys')
        .select('id, slug, start_date, end_date, time_slots, admin_password_hash, title')
        .eq('slug', SURVEY_SLUG)
        .maybeSingle();

      if (!got.data) {
        if (document.getElementById('chooserOnly')) document.getElementById('chooserOnly').classList.remove('hidden');
        if (document.getElementById('app')) document.getElementById('app').classList.add('hidden');
        await fetchAndRenderSessions();
        return false;
      } else {
        applySurveyState(got.data);
        return true;
      }
    }

    async function pullSurvey(){
      const ok = await ensureSurveyExistsOrFail();
      if (!ok) return;
      createAvailabilityTable();
    }

    async function tryAdminLogin(){
      const pwd = document.getElementById('adminPwd')?.value || '';
      const status = document.getElementById('adminStatus');
      if (!ADMIN_HASH) {
        isAdmin = false;
        if (status) status.textContent = "Aucun mot de passe d√©fini pour cette session.";
        const panel = document.getElementById('adminPanel'); if(panel) panel.style.display = 'none';
        return;
      }
      const h = await sha256Hex(pwd);
      const ok = (h === ADMIN_HASH);
      isAdmin = ok;
      if (status) status.textContent = ok ? "Admin activ√© ‚úÖ" : "Mot de passe incorrect.";
      const panel = document.getElementById('adminPanel'); if(panel) panel.style.display = ok ? 'block' : 'none';
    }

    async function applyAdminSettings(){
      if (!isAdmin) return alert("Mode admin requis.");
      if (!SURVEY_ID) return;
      const start=document.getElementById('admStart').value; const end=document.getElementById('admEnd').value;
      if(!start||!end) return alert("Choisissez une date de d√©but et de fin.");
      if(new Date(start)>new Date(end)) return alert("La date de d√©but doit pr√©c√©der la date de fin.");
      TIME_SLOTS = normalizeSlots((TIME_SLOTS||[]).filter(s=>s && s.start && s.end));

      const { data, error } = await supabase
        .from('surveys')
        .update({ start_date:start, end_date:end, time_slots:TIME_SLOTS })
        .eq('id', SURVEY_ID)
        .select('id, start_date, end_date, time_slots, admin_password_hash')
        .maybeSingle();
      if (error) return alert(error.message);
      if (data) applySurveyState(data);

      await pullSurvey();
      userSelections = {};
      createAvailabilityTable();
      alert("‚úÖ P√©riode et cr√©neaux mis √† jour.");
    }

    function buildResponsesJSON(){ const out={}; const allowed=expectedKeySet(); for(const [k,v] of Object.entries(userSelections||{})){ if(allowed.has(k) && v && v!=='unavailable') out[k]=v; } return out; }
    function fillAll(status){ const allowed=expectedKeySet(); Object.keys(userSelections||{}).forEach(k=>{ if(!allowed.has(k)) delete userSelections[k]; }); for(const k of allowed) userSelections[k]=status; createAvailabilityTable(); }

    async function preloadByName(){
      const name=document.getElementById('userName')?.value.trim(); if(!name||!SURVEY_ID) return;
      const { data, error } = await supabase
        .from('submissions_simple')
        .select('responses')
        .eq('survey_id', SURVEY_ID)
        .eq('user_name', name)
        .maybeSingle();
      if (!error && data?.responses) {
        const allowed = expectedKeySet();
        userSelections = Object.fromEntries(Object.entries(data.responses).filter(([k]) => allowed.has(k)));
        createAvailabilityTable();
      } else {
        userSelections = {};
        createAvailabilityTable();
      }
    }

    async function saveToSupabase(){
      const name=document.getElementById('userName')?.value.trim();
      if (!name) return alert("Entrez votre nom.");
      if (!SURVEY_ID) return alert("Choisissez d'abord une session existante.");
      const responses = buildResponsesJSON();
      if (!Object.keys(responses).length) return alert("S√©lectionnez au moins une disponibilit√©.");
      const { error } = await supabase
        .from('submissions_simple')
        .upsert({ survey_id:SURVEY_ID, user_name:name, responses, updated_at:new Date().toISOString() }, { onConflict:'survey_id,user_name' });
      if (error) return alert(error.message);
      alert("‚úÖ R√©ponses enregistr√©es !");
    }

    async function deleteMySubmission(){
      const name=document.getElementById('userName')?.value.trim();
      if (!name) return alert("Entrez votre nom.");
      if (!SURVEY_ID) return alert("Choisissez d'abord une session existante.");
      if (!confirm(`Effacer les r√©ponses de "${name}" ?`)) return;
      const { error } = await supabase
        .from('submissions_simple')
        .delete()
        .eq('survey_id', SURVEY_ID)
        .eq('user_name', name);
      if (error) return alert(error.message);
      userSelections = {};
      createAvailabilityTable();
      alert("üóëÔ∏è R√©ponses effac√©es.");
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      const chooser = document.getElementById('chooserOnly');
      const app = document.getElementById('app');
      if (!SURVEY_SLUG) {
        if (chooser) chooser.classList.remove('hidden');
        if (app) app.classList.add('hidden');
        await fetchAndRenderSessions();
      } else {
        const exists = await ensureSurveyExistsOrFail();
        if (!exists) return;
        if (app) app.classList.remove('hidden');
        const slugEl = document.getElementById('sessionSlug'); if (slugEl) slugEl.textContent = SURVEY_SLUG;
        const recapA = document.getElementById('recapLink'); if (recapA) recapA.href = `recap.html?survey=${encodeURIComponent(SURVEY_SLUG)}`;
        await pullSurvey();
        document.getElementById('adminBtn')?.addEventListener('click', tryAdminLogin);
        const i=document.getElementById('userName'); if(i) i.addEventListener('blur', preloadByName);
      }
    });
  </script>
</head>
<body>
  <div class="container">
    <h1>üìÖ Mes Disponibilit√©s</h1>

    <div id="chooserOnly" class="session-bar hidden">
      <p class="muted">S√©lectionnez une <strong>session existante</strong> pour continuer.</p>
      <div id="errorBox" class="error"></div>
      <div id="noSessions" class="muted hidden">Aucune session n‚Äôest disponible pour l‚Äôinstant.</div>
      <div id="sessionList" class="session-list"></div>
    </div>

    <div id="app" class="hidden">
      <div class="session-bar">
        <span>Session active : <span id="sessionSlug" class="pill"></span></span>
        <a id="recapLink" class="btn-secondary" href="#">üìä Ouvrir le r√©cap</a>
      </div>

      <div class="row admin-login">
        <input id="adminPwd" type="password" placeholder="Mot de passe admin" />
        <button class="btn-secondary" id="adminBtn">Activer Admin</button>
        <span id="adminStatus" style="color:#2c3e50;"></span>
      </div>

      <details class="admin" id="adminPanel" style="display:none;">
        <summary>‚öôÔ∏è Administrateur ‚Äî P√©riode et cr√©neaux (session existante)</summary>
        <div class="admin-grid">
          <div>
            <label for="admStart">D√©but de p√©riode</label>
            <input type="date" id="admStart" />
          </div>
          <div>
            <label for="admEnd">Fin de p√©riode</label>
            <input type="date" id="admEnd" />
          </div>
        </div>

        <div style="margin-top:10px;">
          <strong>Cr√©neaux journaliers</strong>
          <div id="slots" class="slots"></div>
          <button class="btn-secondary" type="button" onclick="addSlot()">+ Ajouter un cr√©neau</button>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn-secondary" type="button" onclick="applyAdminSettings()">Appliquer au sondage</button>
          <a class="btn-secondary" href="recap.html">üìä Ouvrir le r√©cap</a>
        </div>
      </details>

      <div style="margin:12px 0;">
        <input id="userName" class="name-input" placeholder="Votre nom et pr√©nom" />
      </div>

      <div class="row" style="margin:12px 0; justify-content:space-between;">
        <div class="row">
          <button onclick="saveToSupabase()" class="save-btn">üíæ Enregistrer</button>
          <button onclick="deleteMySubmission()" class="save-btn" style="background:#e74c3c;">üóëÔ∏è Effacer mes r√©ponses</button>
        </div>
        <a id="recapLink2" href="#" class="save-btn" style="background:#16a085; text-decoration:none; font-weight:bold; display:none;">üìä Voir le r√©cap</a>
      </div>

      <div class="row" style="margin:12px 0;">
        <button class="auto-btn auto-available" onclick="fillAll('available')">‚úÖ Tout Disponible</button>
        <button class="auto-btn auto-unavailable" onclick="fillAll('unavailable')">‚ùå Tout Indisponible</button>
        <button class="auto-btn auto-maybe" onclick="fillAll('maybe')">‚ùì Tout Peut-√™tre</button>
      </div>

      <div class="legend">
        <div class="legend-item"><span class="availability-option available">‚úì</span>Disponible</div>
        <div class="legend-item"><span class="availability-option unavailable">‚úó</span>Indisponible</div>
        <div class="legend-item"><span class="availability-option maybe">?</span>Peut-√™tre</div>
      </div>

      <div class="calendar">
        <table id="availabilityTable">
          <thead><tr id="theadRow"></tr></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</body>
</html>
