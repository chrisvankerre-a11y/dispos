<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Récapitulatif des disponibilités</title>
  <style>
    body{font-family:Arial,sans-serif;max-width:1200px;margin:0 auto;padding:20px;background:#f5f5f5}
    .container{background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    h1{color:#2c3e50;text-align:center}
    table{border-collapse:collapse;width:100%;min-width:800px}
    th,td{border:1px solid #ddd;padding:10px;text-align:center}
    th{background:#34495e;color:#fff}
    .muted{background:#ecf0f1;color:#7f8c8d}
    .tag{display:inline-block;padding:2px 8px;border-radius:12px;font-size:12px}
    .tag-ok{background:#2ecc71;color:#fff}
    .tag-maybe{background:#f39c12;color:#fff}
    .tag-bad{background:#e74c3c;color:#fff}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:8px;flex-wrap:wrap}
    a.btn{background:#6c757d;color:#fff;text-decoration:none;padding:8px 12px;border-radius:6px}
  </style>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://xxxxx.supabase.co";   // même URL que dans index.html
  const SUPABASE_ANON_KEY = "eyJ...";                 // même clé que dans index.html
  const SURVEY_SLUG = new URLSearchParams(location.search).get("survey") || "nov-2025";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let nonVotingDays = [];
  let startDate, endDate;

  function rangeDates(start, end){
    const out=[]; for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)) out.push(new Date(d)); return out;
  }
  function fmt(d){ const dd=d.getDate(), mm=d.getMonth()+1, yyyy=d.getFullYear(); return `${dd}/${mm}/${yyyy}` }
  function iso(d){ return d.toISOString().slice(0,10) }
  function isMuted(d){ return nonVotingDays.includes(iso(d)) }

  async function getSurvey(){
    const { data, error } = await supabase
      .from("surveys")
      .select("id, start_date, end_date, non_voting_days")
      .eq("slug", SURVEY_SLUG)
      .single();
    if (error) throw error;
    nonVotingDays = (data.non_voting_days || []).map(x=>x.toString());
    startDate = new Date(data.start_date);
    endDate   = new Date(data.end_date);
    return data.id;
  }

  async function getAllResponses(){
    const { data, error } = await supabase
      .from("submissions_simple")
      .select("user_name, responses")
      .eq("survey_id", SURVEY_ID);
    if (error) throw error;
    return data || [];
  }

  function buildTable(responsesList){
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";
    const participants = responsesList.length;

    const dates = rangeDates(startDate, endDate);

    // 1. En-têtes dynamiques : une colonne par participant
    const thead = document.querySelector("#tbl thead tr");
    thead.innerHTML = "<th>Date</th>";
    responsesList.forEach(p => { thead.innerHTML += `<th>${p.user_name || "?"}</th>`; });

    // 2. Contenu
    dates.forEach(d => {
      const key = iso(d);
      const row = document.createElement("tr");
      if (isMuted(d)) row.classList.add("muted");

      let line = `<td>${fmt(d)}</td>`;
      responsesList.forEach(p => {
        const v = p.responses[key];
        let symbol = "";
        if (v === "available") symbol = "✅";
        else if (v === "maybe") symbol = "❓";
        else if (v === "unavailable") symbol = "❌";
        line += `<td>${symbol}</td>`;
      });

      row.innerHTML = line;
      tbody.appendChild(row);
    });

    document.getElementById("meta").textContent =
      `Sondage: ${SURVEY_SLUG} — ${participants} participants`;
  }

  let SURVEY_ID;

  async function init(){
    SURVEY_ID = await getSurvey();
    const list = await getAllResponses();
    buildTable(list);
  }
  init();
</script>
</body>
</html>
