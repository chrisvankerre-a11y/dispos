<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>R√©capitulatif des disponibilit√©s</title>
  <style>
    body{font-family:Arial,sans-serif;max-width:1200px;margin:0 auto;padding:20px;background:#f5f5f5}
    .container{background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    h1{color:#2c3e50;text-align:center}
    table{border-collapse:collapse;width:100%;min-width:800px;margin-top:20px}
    th,td{border:1px solid #ddd;padding:10px;text-align:center}
    th{background:#34495e;color:#fff}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:8px;flex-wrap:wrap}
    a.btn{background:#6c757d;color:#fff;text-decoration:none;padding:8px 12px;border-radius:6px}
    .footer-btn{margin-top:20px;text-align:right;}
    .reset-btn{background:#bdc3c7;color:#2c3e50;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:14px;}
    .reset-btn:hover{background:#95a5a6;}
    .meta-line{color:#2c3e50;margin:6px 0;}
  </style>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://igicmnaxgjzyhujyosse.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnaWNtbmF4Z2p6eWh1anlvc3NlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MjU3OTksImV4cCI6MjA3NzAwMTc5OX0.e2bJclwq4Bn7MrPGJRlDU5pmaJWrgFFBfbWLWEccn_Y";
    const SURVEY_SLUG = new URLSearchParams(location.search).get("survey") || "nov-2025";
    const supabase = window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_ANON_KEY,
      { auth: { persistSession: false, autoRefreshToken: false, detectSessionInUrl: false } }
    );
  </script>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <h1>üßÆ R√©capitulatif des disponibilit√©s</h1>
      <a class="btn" href="./">‚Ü©Ô∏è Retour au formulaire</a>
    </div>

    <div id="meta" class="meta-line"></div>

    <table id="tbl">
      <thead><tr id="theadRow"></tr></thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="footer-btn">
      <button class="reset-btn" onclick="resetAll()">üßπ R√©initialiser le tableau</button>
    </div>
  </div>

  <script>
    let startDate, endDate, SURVEY_ID;
    let timeSlots = [];

    function rangeDates(start, end){
      const out=[]; for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)) out.push(new Date(d)); return out;
    }
    function fmt(d){ const dd=d.getDate(), mm=d.getMonth()+1, yyyy=d.getFullYear(); return `${dd}/${mm}/${yyyy}` }
    function iso(d){ return d.toISOString().slice(0,10) }
    function slotKey(dateIso, s){ return `${dateIso}|${s.start}-${s.end}`; }

    async function getSurvey(){
      const { data, error } = await supabase
        .from("surveys")
        .select("id, start_date, end_date, time_slots, slug, title")
        .eq("slug", SURVEY_SLUG)
        .single();
      if (error) throw error;
      startDate = new Date(data.start_date);
      endDate   = new Date(data.end_date);
      timeSlots = Array.isArray(data.time_slots) ? data.time_slots : [];
      SURVEY_ID = data.id;
      const slotTxt = (timeSlots && timeSlots.length)
        ? timeSlots.map(s=>`${s.start}‚Äì${s.end}`).join(" | ")
        : "Journ√©e enti√®re";
      document.getElementById("meta").textContent =
        `Sondage : ${data.slug} ‚Äî P√©riode ${data.start_date} ‚Üí ${data.end_date} ‚Äî Cr√©neaux : ${slotTxt}`;
    }

    async function getAllResponses(){
      const { data, error } = await supabase
        .from("submissions_simple")
        .select("user_name, responses")
        .eq("survey_id", SURVEY_ID);
      if (error) throw error;
      return data || [];
    }

    function buildTable(responsesList){
      const theadRow = document.getElementById("theadRow");
      const tbody = document.getElementById("tbody");
      theadRow.innerHTML = "";
      tbody.innerHTML = "";

      // En-t√™tes
      theadRow.innerHTML = "<th>Date / Cr√©neau</th>";
      const participants = responsesList.map(r => r.user_name);
      participants.forEach(name => { theadRow.innerHTML += `<th>${name}</th>`; });
      theadRow.innerHTML += "<th>Cr√©neau parfait</th>";

      const dates = rangeDates(startDate, endDate);
      const slots = (timeSlots && timeSlots.length) ? timeSlots : [{start:'', end:''}];

      dates.forEach(d => {
        const dIso = iso(d);
        slots.forEach(s=>{
          const row = document.createElement("tr");
          const key = slotKey(dIso, s);
          let cells = `<td>${fmt(d)}${s.start?` ‚Äî ${s.start}‚Äì${s.end}`:''}</td>`;
          let allAvailable = true;

          responsesList.forEach(r => {
            const val = r.responses?.[key];
            let symbol = "";
            if (val === "available") symbol = "‚úÖ";
            else if (val === "maybe") { symbol = "‚ùì"; allAvailable = false; }
            else { symbol = "‚ùå"; allAvailable = false; }
            cells += `<td>${symbol}</td>`;
          });

          const perfect = (responsesList.length > 0 && allAvailable);
          cells += `<td>${perfect ? "üåü" : ""}</td>`;
          row.innerHTML = cells;
          tbody.appendChild(row);
        });
      });
    }

    async function resetAll(){
      if (!confirm("‚ö†Ô∏è √ätes-vous s√ªr de vouloir effacer toutes les r√©ponses ? Cette action est irr√©versible.")) return;
      const { error } = await supabase
        .from("submissions_simple")
        .delete()
        .eq("survey_id", SURVEY_ID);
      if (error) return alert("Erreur : " + error.message);
      alert("üßπ Toutes les r√©ponses ont √©t√© effac√©es.");
      init();
    }

    async function init(){
      await getSurvey();
      const list = await getAllResponses();
      buildTable(list);
    }
    init();
  </script>
</body>
</html>
