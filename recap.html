<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>R√©capitulatif des disponibilit√©s</title>
  <style>
    body{font-family:Arial,sans-serif;max-width:1200px;margin:0 auto;padding:20px;background:#f5f5f5}
    .container{background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    h1{color:#2c3e50;text-align:center}
    table{border-collapse:collapse;width:100%;min-width:800px;margin-top:20px}
    th,td{border:1px solid #ddd;padding:10px;text-align:center}
    th{background:#34495e;color:#fff}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:8px;flex-wrap:wrap}
    a.btn{background:#6c757d;color:#fff;text-decoration:none;padding:8px 12px;border-radius:6px}
    .footer-btn{margin-top:20px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .reset-btn{background:#bdc3c7;color:#2c3e50;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:14px;}
    .reset-btn:hover{background:#95a5a6;}
    .meta-line{color:#2c3e50;margin:6px 0;}
    .admin-login{display:flex;gap:8px;align-items:center}
    .admin-login input{padding:8px;border:1px solid #ccc;border-radius:6px}
    .admin-login .btn{background:#6c757d;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    .admin-login .btn:hover{opacity:.9}
    .admin-status{color:#2c3e50}
    .session-bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:10px;border:1px dashed #bbb;border-radius:8px;background:#fff;margin-bottom:12px}
    .text-input{padding:10px;font-size:16px;border:2px solid #ddd;border-radius:6px}
    .pill{background:#eef;color:#223;padding:6px 10px;border-radius:999px;font-weight:600}
    .muted{color:#666}
    .btn-ghost{background:transparent;border:1px solid #ccc;color:#333;padding:8px 12px;border-radius:6px;cursor:pointer}
    .btn-ghost:hover{background:#f2f2f2}
    .slot-note{color:#ffd966; font-style:italic; font-weight:600;}
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://igicmnaxgjzyhujyosse.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnaWNtbmF4Z2p6eWh1anlvc3NlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MjU3OTksImV4cCI6MjA3NzAwMTc5OX0.e2bJclwq4Bn7MrPGJRlDU5pmaJWrgFFBfbWLWEccn_Y";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{persistSession:false,autoRefreshToken:false,detectSessionInUrl:false} });

    const SURVEY_SLUG = new URLSearchParams(location.search).get("survey") || "";
    let startDate, endDate, SURVEY_ID, timeSlots=[], ADMIN_HASH=null, isAdmin=false;
    let adminPanelRevealed = false;

    function ymdLocal(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }
    function parseISO(s){ return new Date(`${s}T00:00:00`); }
    function rangeDates(start, end){ const out=[]; for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)) out.push(new Date(d)); return out; }
    function fmt(d){ const dd=d.getDate(), mm=d.getMonth()+1, yyyy=d.getFullYear(); return `${dd}/${mm}/${yyyy}` }
    function slotKey(dateIso, s){ return `${dateIso}|${s.start}-${s.end}`; }
    async function sha256Hex(str){ const enc=new TextEncoder().encode(str); const buf=await crypto.subtle.digest('SHA-256', enc); return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join(''); }
    function headerText(s){ return (s.start&&s.end)?`${s.start}‚Äì${s.end}${s.label? " ‚Äî "+s.label : ""}`:'Journ√©e'; }

    async function getSurvey(){
      const { data, error } = await supabase.from("surveys")
        .select("id, start_date, end_date, time_slots, slug, title, admin_password_hash")
        .eq("slug", SURVEY_SLUG).single();
      if (error) throw error;
      startDate = parseISO(data.start_date);
      endDate   = parseISO(data.end_date);
      timeSlots = Array.isArray(data.time_slots) ? data.time_slots.map(s=>({start:s.start, end:s.end, label:(s.label||"").trim()})) : [];
      SURVEY_ID = data.id;
      ADMIN_HASH = data.admin_password_hash || null;

      const slotTxt = (timeSlots && timeSlots.length) ? timeSlots.map(s=>`${s.start}‚Äì${s.end}${s.label? " ‚Äî "+s.label:""}`).join(" | ") : "Journ√©e enti√®re";
      document.getElementById("meta").textContent = `Sondage : ${data.slug} ‚Äî P√©riode ${data.start_date} ‚Üí ${data.end_date} ‚Äî Cr√©neaux : ${slotTxt}`;
      document.getElementById("sessionShow").textContent = SURVEY_SLUG;
      document.getElementById("backLink").href = `./?survey=${encodeURIComponent(SURVEY_SLUG)}`;

      document.getElementById('adminStatus').textContent = ADMIN_HASH
        ? "Entrez le mot de passe admin."
        : "Aucun mot de passe d√©fini. Cliquez ¬´ Activer Admin ¬ª.";
      reflectAdminUI();
    }

    function revealAdminPanel(){
      adminPanelRevealed = true;
      document.getElementById('openAdminBtn').style.display = 'none';
      document.getElementById('adminLoginWrap').style.display = 'flex';
      document.getElementById('adminPwd').focus();
      reflectAdminUI();
    }

    async function tryAdminLogin(){
      if (!ADMIN_HASH) {
        isAdmin = false;
        document.getElementById('adminStatus').textContent = "Aucun mot de passe d√©fini. D√©finissez-le depuis le formulaire.";
        reflectAdminUI();
        return;
      }
      const pwd=document.getElementById('adminPwd').value||'';
      const h=await sha256Hex(pwd);
      isAdmin=(h===ADMIN_HASH);
      document.getElementById('adminStatus').textContent = isAdmin ? "Admin activ√© ‚úÖ" : "Mot de passe incorrect.";
      reflectAdminUI();
    }

    function reflectAdminUI(){
      const showReset = adminPanelRevealed && isAdmin;
      document.getElementById('resetWrap').style.display = showReset ? 'block' : 'none';
      document.getElementById('adminLoginWrap').style.display = adminPanelRevealed ? 'flex' : 'none';
    }

    async function getAllResponses(){
      const { data, error } = await supabase.from("submissions_simple").select("user_name, responses").eq("survey_id", SURVEY_ID);
      if (error) throw error;
      return data || [];
    }

    function buildTable(responsesList){
      const theadRow=document.getElementById("theadRow"); const tbody=document.getElementById("tbody");
      theadRow.innerHTML=""; tbody.innerHTML="";
      theadRow.innerHTML="<th>Date / Cr√©neau</th>";
      const participants = responsesList.map(r=>r.user_name);
      participants.forEach(name=>{ theadRow.innerHTML += `<th>${name}</th>`; });
      theadRow.innerHTML += "<th>Cr√©neau parfait</th>";

      const dates=rangeDates(startDate,endDate);
      const slots=(timeSlots&&timeSlots.length)?timeSlots:[{start:'',end:'',label:''}];

      dates.forEach(d=>{
        const dIso=ymdLocal(d);
        slots.forEach(s=>{
          const row=document.createElement("tr"); const key=slotKey(dIso,s);
          let cells=`<td>${fmt(d)}${s.start?` ‚Äî ${s.start}‚Äì${s.end}${s.label? " ‚Äî <span class='slot-note'>"+s.label+"</span>":""}`:''}</td>`;
          let allAvailable=true;
          responsesList.forEach(r=>{ const val=r.responses?.[key]; let symbol=""; if(val==="available") symbol="‚úÖ"; else if(val==="maybe"){symbol="‚ùì"; allAvailable=false;} else {symbol="‚ùå"; allAvailable=false;} cells+=`<td>${symbol}</td>`; });
          cells+=`<td>${(responsesList.length>0 && allAvailable)?"üåü":""}</td>`;
          row.innerHTML=cells; tbody.appendChild(row);
        });
      });
    }

    async function resetAll(){
      if (!isAdmin) return alert("Mode administrateur requis.");
      if (!confirm("‚ö†Ô∏è Effacer toutes les r√©ponses de cette session ?")) return;
      const { error } = await supabase.from("submissions_simple").delete().eq("survey_id", SURVEY_ID);
      if (error) return alert("Erreur : "+error.message);
      alert("üßπ Toutes les r√©ponses ont √©t√© effac√©es.");
      init();
    }

    async function init(){
      if (!SURVEY_SLUG){ return; }
      await getSurvey();
      const list=await getAllResponses();
      buildTable(list);
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <h1>üßÆ R√©capitulatif des disponibilit√©s</h1>
      <a id="backLink" class="btn" href="./">‚Ü©Ô∏è Retour au formulaire</a>
    </div>

    <div class="meta-line">Session active : <span id="sessionShow" class="pill"></span></div>
    <div id="meta" class="meta-line"></div>

    <table id="tbl">
      <thead><tr id="theadRow"></tr></thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="footer-btn">
      <button id="openAdminBtn" class="btn-ghost" onclick="revealAdminPanel()">üîê Mode admin</button>
      <div id="adminLoginWrap" class="admin-login" style="display:none;">
        <input id="adminPwd" type="password" placeholder="Mot de passe admin" />
        <button class="btn" onclick="tryAdminLogin()">Activer Admin</button>
        <span id="adminStatus" class="admin-status"></span>
      </div>
      <div id="resetWrap" style="display:none;">
        <button class="reset-btn" onclick="resetAll()">üßπ R√©initialiser le tableau</button>
      </div>
    </div>
  </div>
</body>
</html>
