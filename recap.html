<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>R√©capitulatif des disponibilit√©s</title>
  <style>
    body{font-family:Arial,sans-serif;max-width:1200px;margin:0 auto;padding:20px;background:#f5f5f5}
    .container{background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    h1{color:#2c3e50;text-align:center}
    table{border-collapse:collapse;width:100%;min-width:800px;margin-top:20px}
    th,td{border:1px solid #ddd;padding:10px;text-align:center}
    th{background:#34495e;color:#fff}
    .muted{background:#ecf0f1;color:#7f8c8d}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:8px;flex-wrap:wrap}
    a.btn{background:#6c757d;color:#fff;text-decoration:none;padding:8px 12px;border-radius:6px}
    .footer-btn{margin-top:20px;text-align:right;}
    .reset-btn{background:#bdc3c7;color:#2c3e50;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:14px;}
    .reset-btn:hover{background:#95a5a6;}
  </style>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://igicmnaxgjzyhujyosse.supabase.co";   // ‚Üê m√™me URL que dans index.html
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnaWNtbmF4Z2p6eWh1anlvc3NlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MjU3OTksImV4cCI6MjA3NzAwMTc5OX0.e2bJclwq4Bn7MrPGJRlDU5pmaJWrgFFBfbWLWEccn_Y";                 // ‚Üê m√™me cl√© que dans index.html
    const SURVEY_SLUG = new URLSearchParams(location.search).get("survey") || "nov-2025";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <h1>üßÆ R√©capitulatif des disponibilit√©s</h1>
      <a class="btn" href="./">‚Ü©Ô∏è Retour au formulaire</a>
    </div>

    <div id="meta" style="margin:8px 0; color:#2c3e50;"></div>

    <table id="tbl">
      <thead><tr></tr></thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="footer-btn">
      <button class="reset-btn" onclick="resetAll()">üßπ R√©initialiser le tableau</button>
    </div>
  </div>

  <script>
    let startDate, endDate, SURVEY_ID;
    const nonVotingDays = [];

    function rangeDates(start, end){
      const out=[]; for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)) out.push(new Date(d)); return out;
    }
    function fmt(d){ const dd=d.getDate(), mm=d.getMonth()+1, yyyy=d.getFullYear(); return `${dd}/${mm}/${yyyy}` }
    function iso(d){ return d.toISOString().slice(0,10) }
    function isMuted(d){ return nonVotingDays.includes(iso(d)) }

    async function getSurvey(){
      const { data, error } = await supabase
        .from("surveys")
        .select("id, start_date, end_date, non_voting_days")
        .eq("slug", SURVEY_SLUG)
        .single();
      if (error) throw error;
      startDate = new Date(data.start_date);
      endDate   = new Date(data.end_date);
      (data.non_voting_days || []).forEach(x => nonVotingDays.push(String(x)));
      SURVEY_ID = data.id;
    }

    async function getAllResponses(){
      const { data, error } = await supabase
        .from("submissions_simple")
        .select("user_name, responses")
        .eq("survey_id", SURVEY_ID);
      if (error) throw error;
      return data || [];
    }

    function buildTable(responsesList){
      const tbl   = document.getElementById("tbl");
      const thead = tbl.querySelector("thead tr");
      const tbody = document.getElementById("tbody");

      tbody.innerHTML = "";
      thead.innerHTML = "<th>Date</th>";

      const participants = responsesList.map(r => r.user_name);
      participants.forEach(name => { thead.innerHTML += `<th>${name}</th>`; });
      thead.innerHTML += "<th>Jour parfait</th>";

      const dates = rangeDates(startDate, endDate);

      dates.forEach(d => {
        const key = iso(d);
        const row = document.createElement("tr");
        if (isMuted(d)) row.classList.add("muted");

        let cells = `<td>${fmt(d)}</td>`;
        let allAvailable = true;

        responsesList.forEach(r => {
          const val = r.responses?.[key];
          let symbol = "";
          if (val === "available") symbol = "‚úÖ";
          else if (val === "maybe") { symbol = "‚ùì"; allAvailable = false; }
          else if (val === "unavailable" || !val) { symbol = "‚ùå"; allAvailable = false; }
          cells += `<td>${symbol}</td>`;
        });

        const perfect = (!isMuted(d) && responsesList.length > 0 && allAvailable);
        cells += `<td>${perfect ? "üåü" : ""}</td>`;

        row.innerHTML = cells;
        tbody.appendChild(row);
      });

      document.getElementById("meta").textContent =
        `Sondage : ${SURVEY_SLUG} ‚Äî ${participants.length} participants`;
    }

    async function resetAll(){
      if (!confirm("‚ö†Ô∏è √ätes-vous s√ªr de vouloir effacer toutes les r√©ponses ? Cette action est irr√©versible.")) return;
      const { error } = await supabase
        .from("submissions_simple")
        .delete()
        .eq("survey_id", SURVEY_ID);
      if (error) return alert("Erreur : " + error.message);
      alert("üßπ Toutes les r√©ponses ont √©t√© effac√©es.");
      init(); // recharge le tableau vide
    }

    async function init(){
      await getSurvey();
      const list = await getAllResponses();
      buildTable(list);
    }
    init();
  </script>
</body>
</html>
