<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>R√©capitulatif des disponibilit√©s</title>
  <style>
    body{font-family:Arial,sans-serif;max-width:1200px;margin:0 auto;padding:20px;background:#f5f5f5}
    .container{background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    h1{color:#2c3e50;text-align:center}
    table{border-collapse:collapse;width:100%;min-width:800px;margin-top:20px}
    th,td{border:1px solid #ddd;padding:10px;text-align:center}
    th{background:#34495e;color:#fff}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:8px;flex-wrap:wrap}
    a.btn{background:#6c757d;color:#fff;text-decoration:none;padding:8px 12px;border-radius:6px}
    .footer-btn{margin-top:20px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .reset-btn{background:#bdc3c7;color:#2c3e50;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:14px;}
    .reset-btn:hover{background:#95a5a6;}
    .meta-line{color:#2c3e50;margin:6px 0;}
    .admin-login{display:flex;gap:8px;align-items:center}
    .admin-login input{padding:8px;border:1px solid #ccc;border-radius:6px}
    .admin-login .btn{background:#6c757d;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    .admin-login .btn:hover{opacity:.9}
    .admin-status{color:#2c3e50}
  </style>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // ---- CONFIG SUPABASE (identique √† index.html)
    const SUPABASE_URL = "https://igicmnaxgjzyhujyosse.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnaWNtbmF4Z2p6eWh1anlvc3NlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MjU3OTksImV4cCI6MjA3NzAwMTc5OX0.e2bJclwq4Bn7MrPGJRlDU5pmaJWrgFFBfbWLWEccn_Y";
    const SURVEY_SLUG = new URLSearchParams(location.search).get("survey") || "nov-2025";
    const supabase = window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_ANON_KEY,
      { auth: { persistSession: false, autoRefreshToken: false, detectSessionInUrl: false } }
    );

    // ---- √âTAT
    let startDate, endDate, SURVEY_ID;
    let timeSlots = [];
    let ADMIN_HASH = null;
    let isAdmin = false;

    // ---- UTILS (dates locales pour alignement parfait avec index.html)
    function ymdLocal(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }
    function parseISO(s){ return new Date(`${s}T00:00:00`); } // local midnight
    function rangeDates(start, end){ const out=[]; for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)) out.push(new Date(d)); return out; }
    function fmt(d){ const dd=d.getDate(), mm=d.getMonth()+1, yyyy=d.getFullYear(); return `${dd}/${mm}/${yyyy}` }
    function slotKey(dateIso, s){ return `${dateIso}|${s.start}-${s.end}`; }
    async function sha256Hex(str){ const enc=new TextEncoder().encode(str); const buf=await crypto.subtle.digest('SHA-256', enc); return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join(''); }

    // ---- CHARGEMENT SONDAGE
    async function getSurvey(){
      const { data, error } = await supabase
        .from("surveys")
        .select("id, start_date, end_date, time_slots, slug, title, admin_password_hash")
        .eq("slug", SURVEY_SLUG)
        .single();
      if (error) throw error;

      startDate = parseISO(data.start_date);
      endDate   = parseISO(data.end_date);
      timeSlots = Array.isArray(data.time_slots) ? data.time_slots : [];
      SURVEY_ID = data.id;
      ADMIN_HASH = data.admin_password_hash || null;

      const slotTxt = (timeSlots && timeSlots.length)
        ? timeSlots.map(s=>`${s.start}‚Äì${s.end}`).join(" | ")
        : "Journ√©e enti√®re";
      document.getElementById("meta").textContent =
        `Sondage : ${data.slug} ‚Äî P√©riode ${data.start_date} ‚Üí ${data.end_date} ‚Äî Cr√©neaux : ${slotTxt}`;

      // UI admin: si pas de mot de passe en base, admin ‚Äúlibre‚Äù
      const adminStatus = document.getElementById('adminStatus');
      if (!ADMIN_HASH) {
        isAdmin = true;
        adminStatus.textContent = "Admin libre (aucun mot de passe d√©fini).";
      }
      reflectAdminUI();
    }

    // ---- ADMIN
    async function tryAdminLogin(){
      if (!ADMIN_HASH) { isAdmin = true; reflectAdminUI(); return; }
      const pwd = document.getElementById('adminPwd').value || '';
      const h = await sha256Hex(pwd);
      isAdmin = (h === ADMIN_HASH);
      const adminStatus = document.getElementById('adminStatus');
      adminStatus.textContent = isAdmin ? "Admin activ√© ‚úÖ" : "Mot de passe incorrect.";
      reflectAdminUI();
    }
    function reflectAdminUI(){
      // Affiche/masque le bouton reset selon isAdmin
      document.getElementById('resetWrap').style.display = isAdmin ? 'block' : 'none';
    }

    // ---- R√âCUP DES R√âPONSES
    async function getAllResponses(){
      const { data, error } = await supabase
        .from("submissions_simple")
        .select("user_name, responses")
        .eq("survey_id", SURVEY_ID);
      if (error) throw error;
      return data || [];
    }

    // ---- TABLE
    function buildTable(responsesList){
      const theadRow = document.getElementById("theadRow");
      const tbody = document.getElementById("tbody");
      theadRow.innerHTML = "";
      tbody.innerHTML = "";

      theadRow.innerHTML = "<th>Date / Cr√©neau</th>";
      const participants = responsesList.map(r => r.user_name);
      participants.forEach(name => { theadRow.innerHTML += `<th>${name}</th>`; });
      theadRow.innerHTML += "<th>Cr√©neau parfait</th>";

      const dates = rangeDates(startDate, endDate);
      const slots = (timeSlots && timeSlots.length) ? timeSlots : [{start:'', end:''}];

      dates.forEach(d => {
        const dIso = ymdLocal(d); // LOCAL
        slots.forEach(s=>{
          const row = document.createElement("tr");
          const key = slotKey(dIso, s);
          let cells = `<td>${fmt(d)}${s.start?` ‚Äî ${s.start}‚Äì${s.end}`:''}</td>`;
          let allAvailable = true;

          responsesList.forEach(r => {
            const val = r.responses?.[key];
            let symbol = "";
            if (val === "available") symbol = "‚úÖ";
            else if (val === "maybe") { symbol = "‚ùì"; allAvailable = false; }
            else { symbol = "‚ùå"; allAvailable = false; }
            cells += `<td>${symbol}</td>`;
          });

          const perfect = (responsesList.length > 0 && allAvailable);
          cells += `<td>${perfect ? "üåü" : ""}</td>`;
          row.innerHTML = cells;
          tbody.appendChild(row);
        });
      });
    }

    // ---- RESET (prot√©g√© admin)
    async function resetAll(){
      if (!isAdmin) return alert("Mode administrateur requis.");
      if (!confirm("‚ö†Ô∏è √ätes-vous s√ªr de vouloir effacer toutes les r√©ponses ? Cette action est irr√©versible.")) return;

      const { error } = await supabase
        .from("submissions_simple")
        .delete()
        .eq("survey_id", SURVEY_ID);
      if (error) return alert("Erreur : " + error.message);
      alert("üßπ Toutes les r√©ponses ont √©t√© effac√©es.");
      init();
    }

    // ---- INIT
    async function init(){
      await getSurvey();
      const list = await getAllResponses();
      buildTable(list);
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <h1>üßÆ R√©capitulatif des disponibilit√©s</h1>
      <a class="btn" href="./">‚Ü©Ô∏è Retour au formulaire</a>
    </div>

    <div id="meta" class="meta-line"></div>

    <table id="tbl">
      <thead><tr id="theadRow"></tr></thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="footer-btn">
      <div class="admin-login">
        <input id="adminPwd" type="password" placeholder="Mot de passe admin">
        <button class="btn" onclick="tryAdminLogin()">Activer Admin</button>
        <span id="adminStatus" class="admin-status"></span>
      </div>

      <!-- Le reset n‚Äôest visible que si isAdmin === true -->
      <div id="resetWrap" style="display:none;">
        <button class="reset-btn" onclick="resetAll()">üßπ R√©initialiser le tableau</button>
      </div>
    </div>
  </div>
</body>
</html>
