<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>R√©capitulatif des disponibilit√©s</title>
  <style>
    body{font-family:Arial,sans-serif;max-width:1200px;margin:0 auto;padding:20px;background:#f5f5f5}
    .container{background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    h1{color:#2c3e50;text-align:center}
    table{border-collapse:collapse;width:100%;min-width:800px}
    th,td{border:1px solid #ddd;padding:10px;text-align:center}
    th{background:#34495e;color:#fff}
    .muted{background:#ecf0f1;color:#7f8c8d}
    .tag{display:inline-block;padding:2px 8px;border-radius:12px;font-size:12px}
    .tag-ok{background:#2ecc71;color:#fff}
    .tag-maybe{background:#f39c12;color:#fff}
    .tag-bad{background:#e74c3c;color:#fff}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:8px;flex-wrap:wrap}
    a.btn{background:#6c757d;color:#fff;text-decoration:none;padding:8px 12px;border-radius:6px}
  </style>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://igicmnaxgjzyhujyosse.supabase.co";   // ‚Üê m√™me URL que dans index.html
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnaWNtbmF4Z2p6eWh1anlvc3NlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MjU3OTksImV4cCI6MjA3NzAwMTc5OX0.e2bJclwq4Bn7MrPGJRlDU5pmaJWrgFFBfbWLWEccn_Y";                 // ‚Üê m√™me cl√© que dans index.html
    const SURVEY_SLUG = new URLSearchParams(location.search).get("survey") || "nov-2025";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <h1>üßÆ R√©capitulatif des disponibilit√©s</h1>
      <a class="btn" href="./">‚Ü©Ô∏è Retour au formulaire</a>
    </div>
    <div id="meta" style="margin:8px 0; color:#2c3e50;"></div>

    <table id="tbl">
      <thead>
        <tr>
          <th>Date</th>
          <th>‚úì Disponibles</th>
          <th>? Peut-√™tre</th>
          <th>Total r√©pondants</th>
          <th>Parfait</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <script>
    let nonVotingDays = [];
    let startDate, endDate;

    function rangeDates(start, end){
      const out=[]; for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)) out.push(new Date(d)); return out;
    }
    function fmt(d){ const dd=d.getDate(), mm=d.getMonth()+1, yyyy=d.getFullYear(); return `${dd}/${mm}/${yyyy}` }
    function iso(d){ return d.toISOString().slice(0,10) }
    function isMuted(d){ return nonVotingDays.includes(iso(d)) }

    async function getSurvey(){
      const { data, error } = await supabase
        .from("surveys")
        .select("id, start_date, end_date, non_voting_days")
        .eq("slug", SURVEY_SLUG)
        .single();
      if (error) throw error;
      nonVotingDays = (data.non_voting_days || []).map(x=>x.toString());
      startDate = new Date(data.start_date);
      endDate   = new Date(data.end_date);
      return data.id;
    }

    async function getAllResponses(){
      const { data, error } = await supabase
        .from("public_survey_results")
        .select("responses")
        .eq("slug", SURVEY_SLUG);
      if (error) throw error;
      return data.map(r => r.responses || {});
    }

    function buildTable(responsesList){
      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";
      const participants = responsesList.length;

      // Agr√©gat par date
      const counts = {}; // { 'YYYY-MM-DD': {a: nb available, m: nb maybe} }
      const dates = rangeDates(startDate, endDate);
      dates.forEach(d => counts[iso(d)] = { a:0, m:0 });

      responsesList.forEach(resp => {
        Object.entries(resp).forEach(([d, v]) => {
          if (!counts[d]) counts[d] = { a:0, m:0 };
          if (v === "available") counts[d].a++;
          else if (v === "maybe") counts[d].m++;
        });
      });

      dates.forEach(d => {
        const key = iso(d);
        const row = document.createElement("tr");
        if (isMuted(d)) row.classList.add("muted");

        const a = counts[key]?.a || 0;
        const m = counts[key]?.m || 0;
        const perfect = (!isMuted(d) && participants>0 && a === participants);

        row.innerHTML = `
          <td>${fmt(d)}</td>
          <td><span class="tag tag-ok">${a}</span></td>
          <td><span class="tag tag-maybe">${m}</span></td>
          <td>${participants}</td>
          <td>${perfect ? "üåü" : ""}</td>
        `;
        tbody.appendChild(row);
      });

      document.getElementById("meta").textContent =
        `Sondage: ${SURVEY_SLUG} ‚Äî R√©pondants: ${participants}`;
    }

    async function init(){
      await getSurvey();
      const list = await getAllResponses();
      buildTable(list);
    }
    init();
  </script>
</body>
</html>
